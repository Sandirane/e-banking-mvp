<div class="grid">
  <div class="col-12">
    <div class="text-center p-3 border-round-sm bg-white font-bold">
      <h2>ADMIN DASHBOARD</h2>
    </div>
  </div>
</div>

<div class="card">
  <p-tabs value="0">
    <p-tablist>
      <p-tab value="0"><h3>Tous les comptes</h3></p-tab>
      <p-tab value="1"><h3>Toutes les transactions</h3></p-tab>
    </p-tablist>
    <p-tabpanels>
      <p-tabpanel value="0">
        <p-card>
          <p-table
            #dt1
            [value]="accounts"
            [tableStyle]="{ 'min-width': '50rem' }"
            [paginator]="true"
            [rows]="5"
            [rowsPerPageOptions]="[5, 10, 20]"
            [globalFilterFields]="['id', 'user_id', 'currency']"
            [responsiveLayout]="'scroll'"
            sortMode="multiple"
          >
            <ng-template #caption>
              <div class="grid">
                <div class="col">
                  <div class="app-section-header">
                    <input
                      pInputText
                      type="text"
                      (input)="
                        dt1.filterGlobal($any($event.target).value, 'contains')
                      "
                      placeholder="Recherche globale"
                    />
                  </div>
                </div>

                <div class="col">
                  <p-button
                    pButton
                    [raised]="true"
                    type="button"
                    label="Créer un compte pour un utilisateur"
                    icon="pi pi-plus"
                    (click)="displayModal = true"
                    class="mb-3"
                  />

                  <p-dialog
                    header="Créer un nouveau compte  pour un utilisateur"
                    [(visible)]="displayModal"
                    [modal]="true"
                    [closable]="true"
                    [style]="{ width: '400px' }"
                  >
                    <form (ngSubmit)="onCreateAccount()" #form="ngForm">
                      <div class="p-fluid">
                        <div class="field">
                          <select
                            class="form-input"
                            name="userId"
                            required
                            [(ngModel)]="newAccountUserId"
                          >
                            <option value="" disabled>
                              — Sélectionnez un user —
                            </option>
                            @for(u of users; track u.id){
                            <option [value]="u.id">
                              {{ u.username }} ({{ u.id }})
                            </option>
                            }
                          </select>
                        </div>
                        <div class="field">
                          <label for="newCurrency">Devise</label>
                          <input
                            class="form-input"
                            placeholder="Devise"
                            [(ngModel)]="newAccountCurrency"
                            name="currency"
                            required
                          />
                        </div>
                        <div class="field">
                          <label for="newCurrency">Solde initial</label>
                          <input
                            class="form-input"
                            type="number"
                            placeholder="Solde initial"
                            [(ngModel)]="newAccountBalance"
                            name="balance"
                          />
                        </div>
                      </div>
                      <p-button
                        pButton
                        type="button"
                        label="Annuler"
                        class="p-button-text"
                        (click)="displayModal = false"
                      />
                      <p-button
                        pButton
                        type="submit"
                        label="Créer"
                        [disabled]="form.invalid"
                      />
                    </form>
                  </p-dialog>
                </div>
              </div>
            </ng-template>

            <ng-template #header>
              <tr>
                <th>ID</th>
                <th>User ID</th>
                <th>Devise</th>
                <th>Créé le</th>
                <th>Actions</th>
              </tr>
            </ng-template>
            <ng-template #body let-account>
              <tr>
                <td>{{ account.id }}</td>
                <td>{{ account.user_id }}</td>
                @if(editAccountId !== account.id) {
                <td>{{ account.currency }}</td>
                } @if(editAccountId === account.id) {
                <td>
                  <input
                    [(ngModel)]="editAccountCurrency"
                    name="editCurrency_{{ account.id }}"
                  />
                </td>
                }
                <td>{{ account.created_at | date : "short" }}</td>
                <td>
                  @if(editAccountId !== account.id){
                  <p-button (click)="startEditAccount(account)"
                    >Modifier</p-button
                  >
                  } @if(editAccountId === account.id){
                  <p-button (click)="onUpdateAccount()">Sauvegarder</p-button>
                  }
                  <p-button (click)="onDeleteAccount(account.id)">
                    Supprimer
                  </p-button>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </p-card>
      </p-tabpanel>
      <p-tabpanel value="1">
        <p-card>
          <p-table
            #dt2
            [value]="transactions"
            [tableStyle]="{ 'min-width': '50rem' }"
            dataKey="id"
            [paginator]="true"
            [rows]="5"
            [rowsPerPageOptions]="[5, 10, 20]"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
            [globalFilterFields]="['id', 'id_user', 'amount', 'type']"
            sortMode="multiple"
          >
            <ng-template #caption>
              <div class="grid">
                <div class="col">
                  <div class="app-section-header">
                    <input
                      pInputText
                      type="text"
                      (input)="
                        dt2.filterGlobal($any($event.target).value, 'contains')
                      "
                      placeholder="Recherche globale"
                    />
                  </div>
                </div>

                <div class="col">
                  <p-button
                    pButton
                    [raised]="true"
                    type="button"
                    label="Créer une transaction pour un utilisateur"
                    icon="pi pi-plus"
                    (click)="displayModal = true"
                    class="mb-3"
                  />

                  <p-dialog
                    header="Créer une nouvelle transaction pour un utilisateur"
                    [(visible)]="displayModal"
                    [modal]="true"
                    [closable]="true"
                    [style]="{ width: '400px' }"
                  >
                    <form (ngSubmit)="onCreateTransaction()" #form="ngForm">
                      <select
                        class="form-input"
                        name="transactionAccountId"
                        required
                        [(ngModel)]="newTransactionAccountId"
                      >
                        <option [value]="0" disabled>
                          — Sélectionnez un compte —
                        </option>
                        @for (a of accounts; track a.id) {
                        <option [value]="a.id">
                          {{ a.user_id }} → Compte #{{ a.id }} ({{
                            a.currency
                          }})
                        </option>
                        }
                      </select>

                      <select
                        class="form-input"
                        [(ngModel)]="newTransactionType"
                        name="transactionType"
                      >
                        <option value="deposit">Dépôt</option>
                        <option value="withdraw">Retrait</option>
                      </select>

                      <input
                        class="form-input"
                        type="number"
                        step="0.01"
                        [(ngModel)]="newTransactionAmount"
                        name="transactionAmount"
                        placeholder="Montant"
                        required
                      />
                      <input
                        class="form-input"
                        [(ngModel)]="newTransactionDesc"
                        name="transactionDesc"
                        placeholder="Description"
                      />
                      <p-button
                        pButton
                        type="button"
                        label="Annuler"
                        class="p-button-text"
                        (click)="displayModal = false"
                      />
                      <p-button
                        pButton
                        type="submit"
                        label="Créer"
                        [disabled]="form.invalid"
                      />
                    </form>
                  </p-dialog>
                </div>
              </div>
            </ng-template>

            <ng-template #header>
              <tr>
                <th>ID</th>
                <th>Compte</th>
                <th>Montant</th>
                <th>Type</th>
                <th>Desc.</th>
                <th>Créé le</th>
                <th>Actions</th>
              </tr>
            </ng-template>
            <ng-template #body let-transaction>
              <tr>
                <td>{{ transaction.id }}</td>
                <td>{{ transaction.account_id }}</td>
                @if(editTransactionId !== transaction.id) {
                <td>
                  {{ transaction.amount }}
                </td>
                } @if(editTransactionId === transaction.id) {
                <td>
                  <input
                    [(ngModel)]="editTransactionAmount"
                    name="amt_{{ transaction.id }}"
                  />
                </td>
                }
                <td>{{ transaction.type }}</td>
                @if(editTransactionId !== transaction.id){
                <td>
                  {{ transaction.description }}
                </td>
                } @if(editTransactionId === transaction.id){
                <td>
                  <input
                    [(ngModel)]="editTransactionDesc"
                    name="desc_{{ transaction.id }}"
                  />
                </td>
                }
                <td>{{ transaction.created_at | date : "short" }}</td>
                <td>
                  @if(editTransactionId !== transaction.id) {
                  <p-button (click)="startEditTransaction(transaction)">
                    Modifier
                  </p-button>
                  } @if(editTransactionId === transaction.id){
                  <p-button (click)="onUpdateTransaction()"
                    >Sauvegarder</p-button
                  >
                  }
                  <p-button (click)="onDeleteTransaction(transaction.id)">
                    Supprimer
                  </p-button>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </p-card>
      </p-tabpanel>
    </p-tabpanels>
  </p-tabs>
</div>
